from наки.__main__ import Главна
from тест_терминал import ТестТерминал

ОДРАЂЕНО = 10000


class ТестВежбање():
    def __init__(бре, шпил, лен):
        бре.шпил = шпил
        бре.лен = лен
        бре.избaчени = False
        бре.одрађено = False

    def __len__(бре):
        return ОДРАЂЕНО if бре.одрађено else бре.лен

    def __eq__(бре, друго):
        if isinstance(друго, ТестВежбање):
            return бре.име_шпила() == друго.име_шпила() and len(бре) == len(друго)
        return False

    def __repr__(бре):
        return f"({бре.шпил}, {len(бре)})"

    def __call__(бре, терминал):
        бре.одрађено = True

    def име_шпила(бре):
        return бре.шпил

    def преполови(бре):
        бре.лен = (бре.лен + 1) // 2

    def избаци_промашене(бре):
        if бре.избaчени:
            return
        бре.лен = max(0, бре.лен - 2)
        бре.избaчени = True


def тест_вежбања():
    return [
        ТестВежбање('aaa', 0),
        ТестВежбање('bbb', 5),
        ТестВежбање('ccc', 10),
        ТестВежбање('ddd', 15),
    ]


def test_изађи_одмах():
    рез = Главна(ТестТерминал(['k']), тест_вежбања())()
    assert рез == тест_вежбања()


def test_преполови():
    рез = Главна(ТестТерминал(['p', 'k']), тест_вежбања())()
    for a, б in zip(рез, тест_вежбања()):
        assert a.име_шпила() == б.име_шпила()
        assert len(a) == (len(б) + 1) // 2


def test_избаци_промашене():
    рез = Главна(ТестТерминал(['и', 'k']), тест_вежбања())()
    for a, б in zip(рез, тест_вежбања()):
        assert a.име_шпила() == б.име_шпила()
        assert len(a) == max(0, len(б) - 2)


def test_одради_два():
    рез = Главна(ТестТерминал([2, 3, 'k']), тест_вежбања())()
    assert рез == [
        ТестВежбање('aaa', 0),
        ТестВежбање('bbb', ОДРАЂЕНО),
        ТестВежбање('ccc', ОДРАЂЕНО),
        ТестВежбање('ddd', 15),
    ]


def test_мешовито():
    рез = Главна(ТестТерминал(['i', 1, 'p', 'i', 3, 'k']), тест_вежбања())()
    assert рез == [
        ТестВежбање('aaa', ОДРАЂЕНО),
        ТестВежбање('bbb', 2),
        ТестВежбање('ccc', ОДРАЂЕНО),
        ТестВежбање('ddd', 7),
    ]
