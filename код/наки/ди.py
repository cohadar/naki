from pathlib import Path
from collections import namedtuple
import dependency_injector.containers as containers
import dependency_injector.providers as providers


ТабелаИнтервала = namedtuple('ТабелаИнтервала', ['путања'])
ТабелаКарти = namedtuple('ТабелаКарти', ['путања'])
ТабелаЛинкова = namedtuple('ТабелаЛинкова', ['путања'])
ТабелаЗаписа = namedtuple('ТабелаЗаписа', ['путања'])

ПогледИнтервала = namedtuple('ПогледИнтервала', ['табела'])
ПогледКарти = namedtuple('ПогледКарти', ['табела'])
ПогледЛинкова = namedtuple('ПогледЛинкова', ['табела'])
ПогледЗаписа = namedtuple('ПогледЗаписа', ['табела'])

Шпил = namedtuple('Шпил', ['име', 'п_интервала', 'п_карти', 'п_линкова', 'п_записа'])
Вежбање = namedtuple('Вежбање', ['путања_каталога', 'шпил'])
Терминал = namedtuple('Терминал', [])
UI = namedtuple('UI', ['терминал'])
Главна = namedtuple('Главна', ['ui', 'вежбања'])

ТестТерминал = namedtuple('ТестТерминал', ['команде'])
ТестТабела = namedtuple('ТестТабела', ['путања', 'на_диску'])


def контејнер_табела(путања):
    к = containers.DynamicContainer()
    к.т_интервала = providers.Factory(ТабелаИнтервала, путања=путања.joinpath('интервали.tsv'))
    к.т_карти = providers.Factory(ТабелаКарти, путања=путања.joinpath('карте.tsv'))
    к.т_линкова = providers.Factory(ТабелаЛинкова, путања=путања.joinpath('линкови.tsv'))
    к.т_записа = providers.Factory(ТабелаЗаписа, путања=путања.joinpath('записи.tsv'))
    return к


def контејнер_вежбања(каталог, путања, т):
    к = containers.DynamicContainer()
    к.п_интервала = providers.Factory(ПогледИнтервала, табела=т.т_интервала)
    к.п_карти = providers.Factory(ПогледКарти, табела=т.т_карти)
    к.п_линкова = providers.Factory(ПогледЛинкова, табела=т.т_линкова)
    к.п_записа = providers.Factory(ПогледЗаписа, табела=т.т_записа)
    к.шпил = providers.Factory(
        Шпил,
        име=путања.name,
        п_интервала=к.п_интервала(),
        п_карти=к.п_карти(),
        п_линкова=к.п_линкова(),
        п_записа=к.п_записа())
    к.вежбање = providers.Factory(Вежбање, путања_каталога=каталог, шпил=к.шпил)
    return к


def листа_дирова(каталог):
    return [фајл for фајл in каталог.iterdir() if фајл.is_dir() and not фајл.name.startswith('__')]


def направи_листу_вежбања(гк, каталог):
    дирови = листа_дирова(каталог)
    лк = [гк.контејнер_вежбања(каталог, дир, гк.контејнер_табела(дир)) for дир in дирови]
    вежбања = [к.вежбање() for к in лк]
    return вежбања


def контејнер_главни(каталог):
    гк = containers.DynamicContainer()
    гк.контејнер_вежбања = providers.Callable(контејнер_вежбања)
    гк.контејнер_табела = providers.Callable(контејнер_табела)
    гк.листа_вежбања = providers.Callable(направи_листу_вежбања, гк, каталог)
    гк.терминал = providers.Factory(Терминал)
    гк.ui = providers.Factory(UI, терминал=гк.терминал)
    гк.главна = providers.Factory(Главна, ui=гк.ui, вежбања=гк.листа_вежбања)
    return гк


class ВежбањеЗидар():
    def __init__(бре, каталог, дир):
        бре.каталог = каталог
        бре.дир = дир

    def __call__(бре):
        return бре.вежбање()

    def вежбање(бре):
        return Вежбање(бре.каталог, бре.шпил())

    def шпил(бре):
        return Шпил(
            бре.дир.name,
            бре.п_интервала(бре.дир.joinpath('интервали.tsv')),
            бре.п_карти(бре.дир.joinpath('карте.tsv')),
            бре.п_линкова(бре.дир.joinpath('линкови.tsv')),
            бре.п_записа(бре.дир.joinpath('записи.tsv')))

    def п_интервала(бре, путања):
        return ПогледИнтервала(бре.т_интервала(путања))

    def п_карти(бре, путања):
        return ПогледКарти(бре.т_карти(путања))

    def п_линкова(бре, путања):
        return ПогледЛинкова(бре.т_линкова(путања))

    def п_записа(бре, путања):
        return ПогледЗаписа(бре.т_записа(путања))

    def т_интервала(бре, путања):
        return ТабелаИнтервала(путања)

    def т_карти(бре, путања):
        return ТабелаКарти(путања)

    def т_линкова(бре, путања):
        return ТабелаЛинкова(путања)

    def т_записа(бре, путања):
        return ТабелаЗаписа(путања)


class ГлавнаЗидар():
    def __init__(бре, каталог):
        бре.каталог = каталог
        бре.дирови = листа_дирова(каталог)

    def __call__(бре):
        return бре.главна()

    def главна(бре):
        return Главна(бре.ui(), бре.листа_вежбања())

    def ui(бре):
        return UI(бре.терминал())

    def терминал(бре):
        return Терминал()

    def листа_вежбања(бре):
        return [ВежбањеЗидар(бре.каталог, дир)() for дир in бре.дирови]


def контејнер_тест_табела(путања, лен):
    к = containers.DynamicContainer()
    на_диску = list(range(лен))
    к.т_интервала = providers.Factory(ТестТабела, путања=путања.joinpath('интервали.tsv'), на_диску=на_диску)
    к.т_карти = providers.Factory(ТестТабела, путања=путања.joinpath('карте.tsv'), на_диску=на_диску)
    к.т_линкова = providers.Factory(ТестТабела, путања=путања.joinpath('линкови.tsv'), на_диску=на_диску)
    к.т_записа = providers.Factory(ТестТабела, путања=путања.joinpath('записи.tsv'), на_диску=на_диску)
    return к


def направи_тест_листу_вежбања(гк, каталог):
    дирови = листа_дирова(каталог)
    лк = [гк.контејнер_вежбања(каталог, дир, гк.контејнер_тест_табела(дир, и)) for и, дир in enumerate(дирови, 1)]
    вежбања = [к.вежбање() for к in лк]
    return вежбања


def г1(каталог):
    гк = контејнер_главни(каталог)
    гк.контејнер_тест_табела = providers.Callable(контејнер_тест_табела)
    гк.листа_вежбања.override(providers.Callable(направи_тест_листу_вежбања, гк, каталог))
    гк.терминал.override(providers.Factory(ТестТерминал, ['a', 'b', 'c']))
    return гк.главна()


class ТестВежбањеЗидар(ВежбањеЗидар):
    def __init__(бре, каталог, дир, лен):
        super().__init__(каталог, дир)
        бре.лен = лен
        бре.на_диску = list(range(лен))

    def т_интервала(бре, путања):
        return ТестТабела(путања, бре.на_диску)

    def т_карти(бре, путања):
        return ТестТабела(путања, бре.на_диску)

    def т_линкова(бре, путања):
        return ТестТабела(путања, бре.на_диску)

    def т_записа(бре, путања):
        return ТестТабела(путања, бре.на_диску)


class ТестЗидар(ГлавнаЗидар):
    def __init__(бре, каталог, команде):
        super().__init__(каталог)
        бре.команде = команде

    def терминал(бре):
        return ТестТерминал(бре.команде)

    def листа_вежбања(бре):
        return [ТестВежбањеЗидар(бре.каталог, дир, и)() for и, дир in enumerate(бре.дирови, 1)]


def г2(каталог):
    гз = ТестЗидар(каталог, ['a', 'b', 'c'])
    return гз.главна()


def main():
    каталог = Path('каталог')
    а1 = г1(каталог)
    а2 = г2(каталог)
    print(а1)
    print(а2)
    assert str(а1) == str(а2)


if __name__ == '__main__':
    main()

